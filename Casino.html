<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<!-- 使用後在手機上的大小比較正確 -->
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>賭場</title>
		<!--引用jQuery -->
		<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
		<!--引用Bootstrap-->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
		<style>
			html, body {
				height: 100vh;
				padding:0px;
			}
			.borderRed {
				border-color: #f44336;
			}
		</style>
		<script>
			function azureAjax(parameter, callBack, errFunc, counter){
				var azureUrl="https://onlinegame20240626204926.azurewebsites.net/api/";
				var localUrl="http://localhost:7035/api/";
				$.ajax({
					url: azureUrl+parameter,
					timeout: 180000,
					dataType: 'json',
					type: "GET",
					success: function(result){
						var json = result;
						if(json[0] == "Err")
						{
							$("#rtnMessage")[0].innerText = json[1];
						}
						else
							callBack(json);
					},
					error: function (xhr, status, error) {
						if(errFunc != undefined)
							errFunc(counter);
						else
							alert("ajax連線錯誤: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
					}
				});
			}
			function checkToken(processAfterCheck){
				var num = Number($("#count")[0].value);
				if(num == 10)
				{
					function callBack(json){
						$("#count")[0].value = "1";
						$("#token")[0].value = json[1];
						//檢查成功執行函式
						processAfterCheck();
					}
					var parameter = "TokenRenewal?ID="+$("#id")[0].value+"&Token="+$("#token")[0].value
					azureAjax(parameter,callBack);
				}
				else
				{
					$("#count")[0].value = num+1;
					//沒檢查也執行函式
					processAfterCheck();
				}
			}
//以上為共用函式============================================================
			/*function wakeUp(counter){
				$("#rtnMessage")[0].innerText = "喚醒中，請稍候";
				$("#BigSmall").show();
				$("#CustomBet").hide();
				function callBack(json){
					//不知道為啥不進這段
					if(json[0] == "Err")
					{
						$("#rtnMessage")[0].innerText = "喚醒中，請稍候...";
						wakeUp();
					}
					else
						$("#rtnMessage")[0].innerText = "已喚醒";
				}
				//打補丁 呼叫失敗 再呼叫一次
				function errFunc(counter){
					$("#rtnMessage")[0].innerText = "喚醒中，請稍候...";
					if(counter>3)
					{
						$("#rtnMessage")[0].innerText = "喚醒失敗";
					}
					else
						wakeUp(counter+1);
				}
				azureAjax("WakeUp",callBack,errFunc,counter);
			}*/
			window.onload=function(){
				$("#rtnMessage")[0].innerText="你推開賭場的大門，眼前是一片炫目的霓虹燈和奢華的裝潢。賭場內，色彩繽紛的地毯延展至各個角落，賭桌上方的吊燈閃閃發光。你似乎能聽見裡頭傳來骰子滾動及籌碼碰撞的聲響。";
				$("#BigSmall").show();
				$("#CustomBet").hide();
			}
			function login(){
				function callBack1(json){
					$("#rtnMessage")[0].innerText = " 登錄成功。";
					$("#logArea").hide();
					$("#id")[0].value = json[1];
					$("#token")[0].value = json[2];
					$("#name")[0].innerText = json[3];
					$("#count")[0].value = "1";
					//讀取現金
					function callBack2(json){
						$("#money")[0].innerText = json[1];
						if(Number(json[1])<1000)
							$("#btnNoMoneyHelp").show();
						else
							$("#btnNoMoneyHelp").hide();
						$("#userProfile").show();
					}
					parameter = "CasinoUserData?ID="+$("#id")[0].value+"&Token="+$("#token")[0].value
					azureAjax(parameter,callBack2);
				}
				var parameter = "Login?Account="+$("#account")[0].value+"&Password="+$("#password")[0].value;
				azureAjax(parameter,callBack1);
			}
			function register(){
				function callBack(json){
					$("#rtnMessage")[0].innerText = json[1];
				}
				var parameter="Register?Account="+$("#account")[0].value+"&Password="+$("#password")[0].value+"&Name="+$("#registerName")[0].value;
				azureAjax(parameter,callBack);
			}
			function Betting(betType,betDetail){
				if($("#betAmount")[0].value=="0" || $("#betAmount")[0].value=="")
				{
					$("#rtnMessage")[0].innerText="你將空氣放在桌上，莊家沒有任何反應。";
					return;
				}
				
				function processAfterCheck(){
					function callBack(json){
						$("#rtnMessage")[0].innerText = json[1];
						$("#record")[0].innerText = json[1] + "\n" + $("#record")[0].innerText;
						if(json[1].substring(6,7)=="大")
							$("#bigCount")[0].innerText = Number($("#bigCount")[0].innerText) + 1;
						else if(json[1].substring(6,7)=="小")
							$("#smallCount")[0].innerText = Number($("#smallCount")[0].innerText) + 1;
						var number = Number($("#money")[0].innerText)+Number(json[2]);
						$("#money")[0].innerText = number;
						if(number<1000)
							$("#btnNoMoneyHelp").show();
					}
					var id=$("#id")[0].value;
					var token=$("#token")[0].value;
					var game="賭大小";
					var betAmount = $("#betAmount")[0].value;
					var parameter = "Betting?ID="+id+"&Token="+token+"&Game="+game+"&BetType="+betType+"&betDetail="+betDetail+"&betAmount="+betAmount;
					azureAjax(parameter,callBack);
				}
				//每次呼叫都要檢查Token
				checkToken(processAfterCheck);
			}
			function casinoRank(){
				function processAfterCheck(){
					function callBack(json){
						$("#rankList")[0].innerText = json[1].replaceAll("|","\n");
					}
					var id=$("#id")[0].value;
					var token=$("#token")[0].value;
					var parameter = "CasinoRank?ID="+id+"&Token="+token;
					azureAjax(parameter,callBack);
				}
				//每次呼叫都要檢查Token
				checkToken(processAfterCheck);
			}
			function noMoneyHelp(){
				function processAfterCheck(){
					function callBack(json){
						$("#money")[0].innerText = json[1].replaceAll("|","\n");
						$("#rtnMessage")[0].innerText="你向賭場的工作人員求助，他給了你一些錢。";
						$("#btnNoMoneyHelp").hide();
					}
					var id=$("#id")[0].value;
					var token=$("#token")[0].value;
					var parameter = "BorrowMoney?ID="+id+"&Token="+token;
					azureAjax(parameter,callBack);
				}
				//每次呼叫都要檢查Token
				checkToken(processAfterCheck);
			}
			function changeMode(mode)
			{
				if(mode == "賭大小")
				{
					$("#BigSmall").show();
					$("#CustomBet").hide();
				}
				else if(mode == "私人賭盤")
				{
					$("#BigSmall").hide();
					$("#CustomBet").show();
				}
				return false;
			}
		</script>
	</head>
	<body class="bg-dark text-white">
		<nav class="navbar" style="height:10%">
			<div class="container">
				<a class='navbar-brand text-white'>離開</a>
				<a href="" onclick="return changeMode('賭大小')" class='navbar-brand text-white'>賭大小</a>
				<a href="" onclick="return changeMode('私人賭盤')" class='navbar-brand text-white'>私人賭盤</a>
				<a class='navbar-brand text-white'>借貸</a>
			</div>
		</nav>
		<div id="BigSmall" class="container-fluid" style="height:90%">
			<div class="row" style="height:70%">
				<div class="col-3">
					<div class="row justify-content-center">
						<div class="col-10">
							<label class="col-form-label">排行榜</label>
							<button class="btn btn-success" onclick="casinoRank()">更新</button>
						</div>
					</div>
					<div class="row justify-content-center">
						<div class="col-10" id="rankList"></div>
					</div>
				</div>
				<div class="col-6 bg-success h-100 d-flex flex-column">
					<div class="row justify-content-center">
						<button class="col-3 btn btn-success borderRed m-1" onclick="Betting('Big','0')">
							<span style="display:block;font-size:24px;">大</span>
							<span style="font-size:14px;">1賠1</span>
						</button>
						<button class="col-3 btn btn-success borderRed m-1" onclick="Betting('Triple','0')">
							<span style="display:block;font-size:24px;">圍骰</span>
							<span style="display:block;font-size:14px;">三顆骰子數字相同</span>
							<span style="font-size:14px;">1賠30</span>
						</button>
						<button class="col-3 btn btn-success borderRed m-1" onclick="Betting('Small','0')">
							<span style="display:block;font-size:24px;">小</span>
							<span style="font-size:14px;">1賠1</span>
						</button>
					</div>
					<div class="row justify-content-center">
						<div class="col-2 p-1">
							<button class="w-100 btn btn-success borderRed" onclick="Betting('Triple','1')">
								<span style="display:block;font-size:24px;">圍骰1</span>
								<span style="font-size:14px;">1賠180</span>
							</button>
						</div>
						<div class="col-2 p-1">
							<button class="w-100 btn btn-success borderRed" onclick="Betting('Triple','2')">
								<span style="display:block;font-size:24px;">圍骰2</span>
								<span style="font-size:14px;">1賠180</span>
							</button>
						</div>
						<div class="col-2 p-1">
							<button class="w-100 btn btn-success borderRed " onclick="Betting('Triple','3')">
								<span style="display:block;font-size:24px;">圍骰3</span>
								<span style="font-size:14px;">1賠180</span>
							</button>
						</div>
						<div class="col-2 p-1">
							<button class="w-100 btn btn-success borderRed " onclick="Betting('Triple','4')">
								<span style="display:block;font-size:24px;">圍骰4</span>
								<span style="font-size:14px;">1賠180</span>
							</button>
						</div>
						<div class="col-2 p-1">
							<button class="w-100 btn btn-success borderRed " onclick="Betting('Triple','5')">
								<span style="display:block;font-size:24px;">圍骰5</span>
								<span style="font-size:14px;">1賠180</span>
							</button>
						</div>
						<div class="col-2 p-1">
							<button class="w-100 btn btn-success borderRed " onclick="Betting('Triple','6')">
								<span style="display:block;font-size:24px;">圍骰6</span>
								<span style="font-size:14px;">1賠180</span>
							</button>
						</div>
					</div>
					<div class="row justify-content-center">
						<div class="col-2 p-1">
							<button class="w-100 btn btn-success borderRed" onclick="Betting('Double','1')">
								<span style="display:block;font-size:24px;">雙骰1</span>
								<span style="font-size:14px;">1賠180</span>
							</button>
						</div>
						<div class="col-2 p-1">
							<button class="w-100 btn btn-success borderRed" onclick="Betting('Double','2')">
								<span style="display:block;font-size:24px;">雙骰2</span>
								<span style="font-size:14px;">1賠11</span>
							</button>
						</div>
						<div class="col-2 p-1">
							<button class="w-100 btn btn-success borderRed " onclick="Betting('Double','3')">
								<span style="display:block;font-size:24px;">雙骰3</span>
								<span style="font-size:14px;">1賠11</span>
							</button>
						</div>
						<div class="col-2 p-1">
							<button class="w-100 btn btn-success borderRed " onclick="Betting('Double','4')">
								<span style="display:block;font-size:24px;">雙骰4</span>
								<span style="font-size:14px;">1賠11</span>
							</button>
						</div>
						<div class="col-2 p-1">
							<button class="w-100 btn btn-success borderRed " onclick="Betting('Double','5')">
								<span style="display:block;font-size:24px;">雙骰5</span>
								<span style="font-size:14px;">1賠11</span>
							</button>
						</div>
						<div class="col-2 p-1">
							<button class="w-100 btn btn-success borderRed " onclick="Betting('Double','6')">
								<span style="display:block;font-size:24px;">圍骰6</span>
								<span style="font-size:14px;">1賠11</span>
							</button>
						</div>
					</div>
					<div class="row justify-content-center align-items-center flex-grow-1">
						<div class="col-2 text-end">
							<label class="col-form-label">下注</label>
						</div>
						<div class="col-5">
							<input type="number" class="form-control bg-dark text-white" id="betAmount" maxlength="10"/>
						</div>
					</div>
				</div>
				<div class="col-3 h-100 overflow-auto">
					<div class="row justify-content-center">
						<div class="col-10">
							<label class="col-form-label">記錄</label>
							<button class="btn btn-success" onclick="$('#record')[0].innerText=''">清除</button>
						</div>
					</div>
					<div class="row justify-content-center">
						<div class="col-10">
							<div id="record"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="row" style="height:30%">
				<div class="col-3">
					<div class="row justify-content-center" id="logArea">
						<div class="col-10">
							<div class="row">
								<div class="col-3 text-end">
									<label class="col-form-label">帳號</label>
								</div>
								<div class="col-9">
									<input type="text" class="form-control bg-dark text-white" id="account" maxlength="30"/>
								</div>
							</div>
							<div class="row">
								<div class="col-3 text-end">
									<label class="col-form-label">密碼</label>
								</div>
								<div class="col-9">
									<input type="password" class="form-control bg-dark text-white" id="password" maxlength="30"/>
								</div>
							</div>
							<div class="row">
								<div class="col-3 text-end">
									<label class="col-form-label">姓名</label>
								</div>
								<div class="col-9">
									<input type="text" class="form-control bg-dark text-white" id="registerName" maxlength="30"/>
								</div>
							</div>
							<div class="row">
								<div class="col-12 text-end">
									<button class="btn btn-success" onclick="login()">登錄</button> 
									<button class="btn btn-success" onclick="register()">註冊</button>
									<input type="text" id="id" style="display:none"/>
									<input type="text" id="token" style="display:none"/>
									<input type="text" id="count" style="display:none"/>
								</div>
							</div>
							
						</div>
					</div>
					<div class="row justify-content-center" id="userProfile" style="display:none">
						<div class="col-10">
							<div class="row">
								<div class="col-12">
									<label class="col-form-label">玩家姓名：</label>
									<label class="col-form-label" id="name"></label>
								</div>
							</div>
							<div class="row">
								<div class="col-12">
									<label class="col-form-label">現金：</label>
									<label class="col-form-label" id="money"></label>
									<button id="btnNoMoneyHelp" onclick="noMoneyHelp()">求助</button>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-6">
					訊息：
					<label id="rtnMessage"></label>
				</div>
				<div class="col-3">
					統計：
					<br/>
					大：<label id="bigCount"></label>
					<br/>
					小：<label id="smallCount"></label>
				</div>
			</div>
		</div>
		<div id="CustomBet" class="container-fluid" style="height:90%">
				測試
		</div>
	</body>
</html>